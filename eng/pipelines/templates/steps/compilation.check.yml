parameters:
  - name: Artifact
    type: object
    default: {}
  - name: ArtifactName
    type: string
    default: "not-specified"
  - name: RetryLimit
    type: number
    default: 30

steps:
  - download: current
    artifact: ${{parameters.ArtifactName}}-signed
  
  - pwsh: |
      $pomfDir = "$(Pipeline.Workspace)/${{parameters.ArtifactName}}-signed/${{parameters.Artifact.groupId}}/${{parameters.Artifact.name}}"
      $pomf = Get-ChildItem "$pomfDir/*.pom"
      Copy-Item "$(System.DefaultWorkingDirectory)/eng" "$pomfDir/eng" -Recurse
      while ($retries++ -lt ${{parameters.RetryLimit}}) {
        Write-Host "mvn -f $pomf install"
        mvn -f $pomf clean install
        if ($LASTEXITCODE) {
          if ($retries -ge ${{parameters.RetryLimit}}) {
            exit $LASTEXITCODE
          }
          Write-Host "Install failed, retrying in 1 minute..."
          sleep 60
        } else {
          break
        }
      }
    workingDirectory: $(Pipeline.Workspace)/${{parameters.ArtifactName}}-signed/${{parameters.Artifact.groupId}}/${{parameters.Artifact.name}}
    displayName: "Verify Package Compilation"
